<!DOCTYPE html>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml"
      layout:decorator="admin/layout">
<div layout:fragment="content" class="admin-main layui-anim">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend th:text="|${wechat.nickname}库存列表|"></legend>
    </fieldset>

    <div class="admin-main layui-anim">
        <div class="layui-field-box layui-form">
            <table class="layui-table admin-table">
                <thead>
                <tr>
                    <th style="width: 5%;">编号</th>
                    <th>商品规格</th>
                    <th style="width: 10%;">获取方式</th>
                    <th style="width: 10%;">状态</th>
                    <th style="width: 15%;">创建时间</th>
                    <th style="width: 20%;">操作</th>
                </tr>
                </thead>
                <tbody id="content">
                <th:block th:each="info : ${infos.list}">
                    <tr>
                        <td>
                            <th:block th:text="${info.stockId}"></th:block>
                        </td>
                        <td>
                            <th:block th:text="${productLogic.GetProduct(info.productId).productName}"></th:block>
                            <th:block th:with="spec=${productLogic.GetProductSpec(info.productSpecId)}">
                                <th:block th:text="${spec.SpecName}"></th:block>
                            </th:block>
                        </td>
                        <td th:text="${enumLogic.GetStockType(info.typeId).message}"></td>
                        <td th:text="${enumLogic.GetStockStatus(info.status).message}"></td>
                        <td th:text="${dateUtils.formatDateByUnixTime(info.createTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td>

                            <th:block th:with="stock=${stockLogic.GetStock(info.stockId)}">
                                <th:block th:if="${stock.giftDto!=null}">
                                    <button type="button"
                                            th:title="|库存${stock.stockId}赠送记录|"
                                            th:attr="data-tab-href=@{'/admin/wechat/giftStock/'+${stock.giftDto.giftId}+'/'+${stock.stockId}}"
                                            class="layui-btn layui-btn-xs">赠送记录
                                    </button>
                                </th:block>
                            </th:block>

                            <th:block th:if="${info.parentStockId != null}"
                                      th:with="stock=${stockLogic.GetStock(info.parentStockId)}">
                                <th:block th:if="${stock.giftDto!=null}">
                                    <button type="button"
                                            th:title="|库存${stock.stockId}获赠记录|"
                                            th:attr="data-tab-href=@{'/admin/wechat/giftStock/'+${stock.giftDto.giftId}+'/'+${stock.stockId}}"
                                            class="layui-btn layui-btn-xs">获赠记录
                                    </button>
                                </th:block>
                            </th:block>

                            <button type="button"
                                    th:attr="data-method='stockFlows', data-id=${info.stockId}"
                                    class="layui-btn layui-btn-xs layui-btn-normal">流转日志
                            </button>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
        <div th:replace="comm/macros :: pageAdminNav(${infos})"></div>
    </div>

</div>


<th:block layout:fragment="script">
    <script th:inline="javascript">
        TX.INIT(function () {

            $("button[data-method]").click(function () {

                var id = $(this).attr("data-id");
                var method = $(this).attr("data-method");
                var that = this;

                if (method == "stockFlows") {
                    getStockFlows(id, that);
                }


            });

            $(document).on("click", function (e) {
                if ($(e.target).hasClass("layui-layer-content")) {
                    return;
                }
                layer.closeAll("tips");
            });

            function getStockFlows(id, that) {

                TX.CORE.p({
                    data: {id: id},
                    url: "/admin/wechat/" + id + "/stockFlows",
                    success: function (resp) {
                        if (resp.baseResp.success) {
                            var html = [];
                            $.each(resp.datas, function (i, item) {
                                var createTime = new moment(item.createTime * 1000).format("YYYY-MM-DD HH:mm:ss");
                                html.push("【" + createTime + "】【" + item.nickName + " " + item.openId + "】" + item.flowName);
                            });
                            if (html.length == 0) {
                                html.push("暂无记录");
                            }
                            layer.tips(html.join("<br />"), that, {
                                time: 15 * 1000,
                                area: 'auto',
                                maxWidth: '800'
                            });

                        }
                    }
                });
            }

        });
    </script>
</th:block>

</html>