<!DOCTYPE html>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      layout:decorator="admin/layout">
<script src="static/common/plugins/layui/layui.js" charset="utf-8"></script>
<link rel="stylesheet" href="static/common/plugins/layui/css/layui.css" media="all">
<div layout:fragment="content" class="admin-main layui-anim" style="margin: 15px;">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend th:if="${info.activityId == null}" th:text="添加活动"></legend>
        <legend th:if="${info.activityId > 0}" th:text="|${info.activityName} 信息编辑|"></legend>
    </fieldset>

    <form class="layui-form" method="post" action="">


        <div class="layui-form-item">
            <label class="layui-form-label">活动名称</label>
            <div class="layui-input-inline" style="width: 85%;">
                <input type="text" class="layui-input" name="activityName"
                       lay-verify="req"
                       title="活动名称"
                       th:value="${info.activityName}" placeholder="请输入活动名称"/>
            </div>
            <div class="layui-form-mid layui-word-aux layui-word-aux-red">*</div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">活动类型</label>
            <div class="layui-input-block">
                <th:block th:each="type : ${activityTypes}">
                    <input type="checkbox" name="typeId"
                           style="width:20px;height:20px;"
                           lay-filter="typeId"
                           th:title="${type.message}" th:value="${type.value}"
                           th:checked="${info.typeId == type.value}">
                </th:block>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">开始时间</label>
                <div class="layui-input-inline">
                    <input type="text" name="beginTime" id="beginTime" placeholder="yyyy-MM-dd HH:mm:ss"
                           th:value="${dateUtils.formatDateByUnixTime(info.beginTime, 'yyyy-MM-dd HH:mm:ss')}"
                           autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-inline">
                <label class="layui-form-label">结束时间</label>
                <div class="layui-input-inline">
                    <input type="text" name="endTime" id="endTime" placeholder="yyyy-MM-dd HH:mm:ss"
                           th:value="${dateUtils.formatDateByUnixTime(info.endTime, 'yyyy-MM-dd HH:mm:ss')}"
                           autocomplete="off" class="layui-input">
                </div>
            </div>

        </div>

        <div class="layui-form-item" id="price" style="display: none;">
            <label class="layui-form-label">售价</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" name="salePrice"
                       lay-verify="float4"
                       title="售价"
                       th:value="${info.salePrice}" placeholder="请输入售价"/>
            </div>
            <div class="layui-form-mid layui-word-aux layui-word-aux-red">*</div>


            <label class="layui-form-label">原价</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" name="originalPrice"
                       lay-verify="float4"
                       title="原价"
                       th:value="${info.originalPrice}" placeholder="请输入原价"/>
            </div>
            <div class="layui-form-mid layui-word-aux layui-word-aux-red">*</div>
        </div>


        <div class="layui-form-item" style="display: none;" id="groupNumber">
            <label class="layui-form-label">参与人数</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" name="number"
                       lay-verify="num2"
                       title="参与人数"
                       th:value="${info.number}" placeholder="参与人数"/>
            </div>
            <div class="layui-form-mid layui-word-aux layui-word-aux-red">*</div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">库存</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" name="stockCount"
                       lay-verify="num2"
                       title="库存"
                       th:value="${info.stockCount}" placeholder="库存"/>
            </div>
            <div class="layui-form-mid layui-word-aux layui-word-aux-red">*</div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">审核</label>
            <div class="layui-input-inline">
                <input type="checkbox" th:checked="${info.ifpass}" name="ifpass" lay-skin="switch" lay-text="已审|未审">
            </div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend th:text="活动商品管理"></legend>
        </fieldset>
        <div class="layui-form-item" style="float: right;">
            <div class="layui-input-inline">
                <button lay-filter="search" class="layui-btn layui-btn-normal layui-btn-xs" type="button"
                        id="btnChooseProducts"
                        style="float: right;">
                    <i class="layui-icon">&#xe654;</i> 添加商品
                </button>
            </div>

        </div>


        <table class="layui-table" lay-size="sm">
            <thead>
            <tr>
                <th style="width: 5%;">编号</th>
                <th>商品规格</th>
                <th style="width: 5%;">售价</th>
                <th style="width: 5%;">原价</th>
                <th style="width: 5%;">库存</th>
                <th style="width: 10%; display: none;" skillprice>秒杀价</th>
                <th style="width: 5%;">操作</th>
            </tr>
            </thead>
            <tbody id="content">
            <th:block th:each="info : ${activityProducts}">
                <tr>
                    <th:block th:with="pro=${productLogic.GetProduct(info.productId)}">
                        <td th:text="${info.productSpecId}"></td>
                        <td>
                            <th:block th:text="${pro.productName}"></th:block>
                            <th:block th:text="${productLogic.GetProductSpec(info.productSpecId).specName}"></th:block>
                        </td>
                        <td th:text="${pro.salePrice}"></td>
                        <td th:text="${pro.originalPrice}"></td>
                        <td th:text="${pro.stockCount}"></td>
                        <td style="display: none;" skillprice>
                            <input type="text" class="layui-input" name="productSpecSalePrice"
                                   lay-verify="float4"
                                   title="秒杀价"
                                   style="height:20px;"
                                   th:value="${info.salePrice}" placeholder="请输入秒杀价"/>
                        </td>
                    </th:block>
                    <td>
                        <input type="hidden" name="productSpecId" th:value="${info.productSpecId}"/>
                        <button type="button" th:attr="data-method='delete',data-id=${info.productSpecId}"
                                class="layui-btn layui-btn-xs layui-btn-danger">
                            <i class="layui-icon">&#xe640;</i>
                            删除
                        </button>
                    </td>
                </tr>
            </th:block>
            </tbody>
        </table>


        <div class="layui-form-item">
            <div class="layui-input-block" style="float: left;margin-left: 15px;">
                <button type="button" class="layui-btn" lay-submit="">
                    <i class="layui-icon">&#xe621;</i>
                    保存
                </button>
                <button type="button" class="layui-btn" id="btnClose">
                    <i class="layui-icon">&#x1006;</i>
                    关闭
                </button>
            </div>
        </div>

    </form>

</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        TX.INIT(function (layui) {

            var form = layui.form;

            //监听指定开关
            form.on('checkbox(typeId)', function (data) {

                $("#groupNumber").hide();
                $("#price").hide();
                $("td[skillprice], th[skillprice]").hide();


                $(":text[name='number']").attr("lay-verify", "num2");
                $(":text[name='originalPrice']").attr("lay-verify", "float4");
                $(":text[name='salePrice']").attr("lay-verify", "float4");
                $(":text[name='productSpecSalePrice']").attr("lay-verify", "float4");

                //所选类型
                var typeId = data.value;

                $(":checkbox[name='typeId']").not($(data.elem)).removeAttr("checked");
                $(data.elem).attr("checked", "checked");

                switch (typeId) {
                    //团单
                    case "10":
                        $("#groupNumber").show();
                        $("#price").show();
                        $(":text[name='productSpecSalePrice']").removeAttr("lay-verify");
                        break;
                    //秒杀
                    case "20":
                        $("td[skillprice], th[skillprice]").show();
                        $(":text[name='number']").removeAttr("lay-verify");
                        $(":text[name='originalPrice']").removeAttr("lay-verify");
                        $(":text[name='salePrice']").removeAttr("lay-verify");
                        break;
                    case "30":
                        //组合
                        $("#price").show();
                        $(":text[name='number']").removeAttr("lay-verify");
                        $(":text[name='productSpecSalePrice']").removeAttr("lay-verify");
                        break;
                }
                form.render();
            });

            //数据提交
            form.on("submit", function (data) {

                if ($("tr #content").length == 0) {
                    layer.alert("至少为此活动添加一个商品");
                    return false;
                }

                TX.CORE.p({
                    data: $("form.layui-form").serialize(),
                    success: function (resp) {
                        if (resp.baseResp.success) {
                            TX.MSG.msg(resp.baseResp.message, {time: 1500}, function () {
                                parent.tab.openTab("/admin/activity", {refershType: "refersh"});
                                // location.href = "/admin/activity";
                            });
                        } else {
                            TX.MSG.msg(resp.baseResp.message, {icon: 2});
                        }
                    }
                });

            });

            //关闭
            $("#btnClose").click(function () {
                if (parent.window.TX.TEMP.LAYERINDEX) {
                    parent.window.layer.close(parent.window.TX.TEMP.LAYERINDEX);
                } else {
                    var currentTabId = parent.tab.getCurrentTabId();
                    parent.tab.deleteTab(currentTabId);
                }
            });

            //日期
            laydate.render({
                elem: '#beginTime',
                type: 'datetime'
            });
            laydate.render({
                elem: '#endTime',
                type: 'datetime'
            });

            //选择商品
            $("#btnChooseProducts").click(function () {
                var choosedSpecIds = choosedProductSpecIds();
                window.TX.TEMP.LAYERINDEX = window.layer.open({
                    title: "",
                    type: 2,
                    btn: ['选择', '关闭'],
                    content: "/admin/activity/chooseProducts?specIds=" + choosedSpecIds.join(',') + "&" + Math.random(),
                    area: ["800px", "600px"],
                    yes: function (index, layero) {
                        var iframe = layero.find('iframe');
                        iframe.contents().find("button[lay-submit]").click();
                    }
                });
            });


            /**
             * 删除所选商品
             */
            $(document).on("click", "button[data-method='delete']", function () {

                var self = this;
                layer.confirm('确定所选商品吗?', {icon: 3}, function (index) {
                    layer.close(index);
                    $(self).parents("tr:first").remove();
                });

            });

            //触发点击活动类型事件
            var activityTypeId = [[${info.typeId}]];
            if (activityTypeId) {
                $(":checkbox[name='typeId'][value='" + activityTypeId + "']").next("div.layui-form-checkbox").trigger("click");
            }

        });


        /**
         * 获取所选规格编号
         */
        function choosedProductSpecIds() {
            var specIds = [];
            $(":hidden[name='productSpecId']").each(function () {
                specIds.push(parseInt(this.value, 10));
            });
            return specIds;
        }

        /**
         * 选择商品规格
         * @param pss
         */
        function chooseProductSpecs(specIds) {

            if (specIds.length == 0) {
                return;
            }

            var choosedSpecIds = choosedProductSpecIds();

            TX.CORE.p({
                data: {specIds: specIds.join(',')},
                url: "/admin/activity/activityProductSpecs",
                success: function (resp) {
                    if (resp.baseResp.success) {

                        if (!resp.datas || resp.datas.length == 0) {
                            return;
                        }
                        var html = [];
                        console.log("响应数据", resp.datas);
                        $.each(resp.datas, function (i, item) {
                            if ($.inArray(item.productSpecId, choosedSpecIds) != -1) {
                                return true;
                            }
                            html.push('<tr>');
                            html.push('    <td>' + item.productName + '</td>');
                            html.push('    <td>' + item.specName + '</td>');
                            html.push('    <td>' + item.salePrice + '</td>');
                            html.push('    <td>' + item.originalPrice + '</td>');
                            html.push('    <td>' + item.stockCount + '</td> ');

                            html.push('    <td style="display: none;" skillprice>');
                            html.push('     <input type="text" class="layui-input" name="productSpecSalePrice" lay-verify="req" title="秒杀价" style="height:20px;" value="0" placeholder="请输入秒杀价"/>');
                            html.push('    </td>');

                            html.push('    <td>');
                            html.push('     <input type="hidden" name="productSpecId" value="' + item.productSpecId + '"/>');
                            html.push('     <button type="button" data-method="delete" data-id="' + item.productSpecId + '" class="layui-btn layui-btn-xs layui-btn-danger">');
                            html.push('     <i class="layui-icon">&#xe640;</i>删除</button>');
                            html.push('    </td>');
                            html.push('</tr>');

                        });

                        $(html.join('')).appendTo($("#content"));

                    } else {
                        TX.MSG.msg(resp.baseResp.message, {icon: 2});
                    }
                }
            });
        }
    </script>
</th:block>
</html>